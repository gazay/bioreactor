#!/usr/bin/env ruby

$0 = 'websocket'

require 'bundler'
Bundler.require :websocket
$:.unshift './lib'
require 'cell'
require 'map'
require 'worm'
require 'human'

EM.run do

  EM::WebSocket.start(host: 'bioreactor.r10.railsrumble.com', port: 8080) do |socket|

    socket.onopen do
      socket.send "Set-Cookie: highlight=#{socket.object_id}"
      Worm.new socket
    end

    socket.onclose do
      Worm.destroy socket
    end

    socket.onmessage do |message|
      Worm.find(socket).direction = message.to_i
    end

  end

  EM::PeriodicTimer.new(0.1) do
    json = Map.data.to_json
    Worm.sockets.each do |socket|
      socket.send json
    end
  end

end
